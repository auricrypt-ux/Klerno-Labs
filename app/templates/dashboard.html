{% extends "base.html" %}
{% block content %}
<style>
  /* keep your vibe + background layer */
  canvas#bg{position:fixed; inset:0; width:100%; height:100%; display:block; z-index:0}
  .vignette{
    position:fixed; inset:0; z-index:1; pointer-events:none;
    background:radial-gradient(1200px 600px at 70% 20%,transparent 0%,rgba(0,0,0,.35) 70%,rgba(0,0,0,.7) 100%);
    mix-blend-mode:multiply;
  }
  /* cards already themed via base.css tokens; these tighten spacing a bit */
  .k-card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; }
  .k-badge{ border:1px solid var(--line); color:#cfe1ff; background:rgba(255,255,255,.04); }
</style>

<canvas id="bg" aria-hidden="true"></canvas>
<div class="vignette" aria-hidden="true"></div>

<header class="mb-2" aria-label="secondary">
  <!-- Tabs bar (preserve IDs & roles exactly as your JS expects) -->
  <div class="border-bottom border-line sticky-top" style="top: 56px; backdrop-filter: blur(6px); background:rgba(0,0,0,.25)">
    <nav id="tabs" class="nav nav-pills gap-2 container py-2" role="tablist" aria-label="Primary">
      <button id="tab-home"    class="btn btn-sm chip"        role="tab" aria-controls="panel-home"    aria-selected="false" tabindex="-1">Home</button>
      <button id="tab-explore" class="btn btn-sm chip"        role="tab" aria-controls="panel-explore" aria-selected="false" tabindex="-1">Explore</button>
      <button id="tab-create"  class="btn btn-sm chip"        role="tab" aria-controls="panel-create"  aria-selected="false" tabindex="-1">Create</button>
      <button id="tab-alerts"  class="btn btn-sm chip"        role="tab" aria-controls="panel-alerts"  aria-selected="false" tabindex="-1">Alerts</button>
      <button id="tab-profile" class="btn btn-sm chip"        role="tab" aria-controls="panel-profile" aria-selected="false" tabindex="-1">Profile</button>
      <button id="tab-admin"   class="btn btn-sm chip tab--admin" role="tab" aria-controls="panel-admin" aria-selected="false" tabindex="-1">Admin</button>
    </nav>
  </div>
</header>

<main id="main" tabindex="-1" class="position-relative" style="z-index:2">
  <!-- HOME -->
  <section id="panel-home" role="tabpanel" aria-labelledby="tab-home" hidden>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="k-card p-3">
          <div class="text-muted mb-1">Total processed</div>
          <div class="fs-3 fw-bold" id="kpiTotal">‚Äî</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="k-card p-3">
          <div class="text-muted mb-1">Alerts ‚â• threshold</div>
          <div class="fs-3 fw-bold" id="kpiAlerts">‚Äî</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="k-card p-3">
          <div class="text-muted mb-1">
            Average risk <small id="kpiAvgDelta" class="text-muted"></small>
          </div>
          <div class="fs-3 fw-bold" id="kpiAvg">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-lg-8">
        <div class="k-card p-3">
          <div class="text-muted mb-2">Average risk by day</div>
          <!-- keep your manual canvas chart (IDs unchanged) -->
          <canvas id="chartRisk" height="220"></canvas>
          <div class="form-text">Canvas chart from <code>/metrics-ui.series_by_day</code>.</div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="k-card p-3">
          <div class="text-muted mb-2">Top categories</div>
          <div id="cats">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="k-card p-3 mt-3">
      <div class="text-muted mb-2">Quick actions</div>
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-light btn-sm" id="fetchXRPL">‚ö° Fetch XRPL (demo)</a>
        <a class="btn btn-outline-light btn-sm" id="analyzeSample">üß™ Analyze sample</a>
        <a class="btn btn-outline-light btn-sm" id="exportCsv" target="_blank" rel="noopener">‚¨áÔ∏è Export CSV</a>
        <button class="btn btn-primary btn-sm" id="btnLoadDemo" type="button">‚ú® Load demo data</button>
      </div>
      <div class="form-text mt-2">These run using your signed-in session (no API key needed).</div>
    </div>

    <div class="k-card p-3 mt-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Recent (live)</div>
        <div class="form-check form-switch">
          <input id="onlyThresh" class="form-check-input" type="checkbox">
          <label for="onlyThresh" class="form-check-label">Only ‚â• threshold</label>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead><tr><th>Time</th><th>From ‚Üí To</th><th>Amount</th><th>Category</th><th>Risk</th></tr></thead>
          <tbody id="tblRecent"><tr><td colspan="5" class="text-muted">loading‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- EXPLORE -->
  <section id="panel-explore" role="tabpanel" aria-labelledby="tab-explore" hidden>
    <div class="k-card p-3 mb-3">
      <h2 class="h5 m-0">Explore</h2>
      <p class="text-muted mb-0 mt-2">Coming soon.</p>
    </div>
  </section>

  <!-- CREATE (Saved wallets) -->
  <section id="panel-create" role="tabpanel" aria-labelledby="tab-create" hidden>
    <div class="k-card p-3">
      <h2 class="h5 m-0 mb-2">Saved wallets</h2>
      <div class="d-flex flex-wrap gap-2 mb-2">
        <input id="walletInput" class="form-control" style="max-width:420px" placeholder="rEb8TK3gBgk5..." />
        <button class="btn btn-outline-light" id="btnAddWallet" type="button">Ôºã Save</button>
      </div>
      <div id="walletList" class="text-muted">No wallets yet.</div>
    </div>
  </section>

  <!-- ALERTS (panel placeholder; full page still at /alerts-ui) -->
  <section id="panel-alerts" role="tabpanel" aria-labelledby="tab-alerts" hidden>
    <div class="k-card p-3">
      <h2 class="h5 m-0">Alerts</h2>
      <p class="text-muted mb-0">Live alerts & filters live here.</p>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="panel-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
    <div class="k-card p-3">
      <h2 class="h5 m-0">Profile</h2>
      <p class="text-muted mb-0">Signed in as <em id="meEmail">‚Äî</em>. Role: <code id="meRole">‚Äî</code>.</p>
      <div class="form-text">Transactions folders live here soon (years & exports).</div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="panel-admin" role="tabpanel" aria-labelledby="tab-admin" hidden>
    <div class="k-card p-3">
      <h2 class="h5 m-0">Admin</h2>
      <p class="text-muted mb-2">Admin tools. Restricted to administrators.</p>
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-outline-light" href="/docs" target="_blank" rel="noopener">üìú API Docs</a>
        <a class="btn btn-outline-light" href="/admin/test-email?key={{ key or '' }}" target="_blank" rel="noopener">‚úâÔ∏è Send test email</a>
      </div>
    </div>
  </section>
</main>

<!-- Toasts container (IDs preserved) -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts" aria-live="polite" aria-atomic="true"></div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const toasts = $('#toasts');
  const body = document.body;
  const tabs = $$('#tabs [role="tab"]');
  const panels = $$('[role="tabpanel"]');

  function toast(msg, type='ok', ms=2400){
    const el = document.createElement('div');
    const kind = type==='ok'?'success': type==='err'?'danger': type==='warn'?'warning':'secondary';
    el.className = 'toast text-bg-'+kind+' border-0';
    el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
    toasts.appendChild(el);
    const t = new bootstrap.Toast(el, { delay: ms });
    t.show();
    el.addEventListener('hidden.bs.toast', ()=> el.remove());
  }

  // ---- CSRF helper (send header on session POSTs)
  function readCookie(name){
    return document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1];
  }
  function withCsrf(init={}){
    const t = readCookie('csrf_token');
    const headers = Object.assign({}, init.headers||{}, t ? {'X-CSRF-Token': t} : {});
    return Object.assign({}, init, { headers, credentials:'include' });
  }

  async function loadMe(){
    try{
      const r = await fetch('/me', {credentials:'include'});
      if(!r.ok) throw 0;
      const me = await r.json();
      body.dataset.role = (me.role || 'viewer');
      $('#meEmail') && ($('#meEmail').textContent = me.email || '‚Äî');
      $('#meRole')  && ($('#meRole').textContent  = me.role  || '‚Äî');
    }catch{ body.dataset.role=''; }
  }

  function fmt(n){ return Intl.NumberFormat().format(n); }
  function paintKPIs(m){
    $('#kpiTotal').textContent = fmt(m.total || 0);
    $('#kpiAlerts').textContent = fmt(m.alerts || 0);
    $('#kpiAvg').textContent = (m.avg_risk ?? 0).toFixed(3);

    const s = m.series_by_day || [];
    const elDelta = $('#kpiAvgDelta');
    if (s.length >= 2 && elDelta) {
      const last = +s[s.length-1].avg_risk || 0;
      const prev = +s[s.length-2].avg_risk || 0;
      const delta = (last - prev) / (prev || 1) * 100;
      elDelta.textContent = ' ‚Ä¢ ' + (delta>=0? '‚ñ≤':'‚ñº') + Math.abs(delta).toFixed(1) + '%';
    } else if (elDelta) elDelta.textContent = '';

    const catsDiv = $('#cats');
    if (catsDiv){
      const cats = Object.entries(m.categories || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
      catsDiv.innerHTML = cats.length ? cats.map(([k,v])=>`<span class="badge k-badge me-1">${k} ¬∑ ${v}</span>`).join(' ')
                                      : '<span class="text-muted">none</span>';
    }
  }

  // keep your manual canvas chart
  function paintChart(series){
    const cv = $('#chartRisk'); if(!cv) return;
    const dpr = Math.min(window.devicePixelRatio||1,2);
    const parent = cv.parentElement;
    const w = parent.clientWidth, h = 220;
    cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
    cv.style.width = w+'px'; cv.style.height = h+'px';
    const ctx = cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    if(!series.length){ ctx.fillStyle='rgba(255,255,255,.45)'; ctx.fillText('No data yet', 16, 24); return; }
    const xs = series.map(d => new Date(d.date).getTime());
    const ys = series.map(d => +d.avg_risk || 0);
    const minX=Math.min(...xs), maxX=Math.max(...xs);
    const minY=Math.min(0, ...ys), maxY=Math.max(1, ...ys);
    const pad=16, top=10, bottom=28;
    const iw = w - pad*2, ih = h - top - bottom;
    const X = t => pad + ((t-minX)/(maxX-minX || 1))*iw;
    const Y = v => top + ih - ((v-minY)/(maxY-minY || 1))*ih;
    const grad = ctx.createLinearGradient(0, top, 0, top+ih);
    grad.addColorStop(0,'rgba(123,108,255,.45)'); grad.addColorStop(1,'rgba(123,108,255,0)');
    ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
    for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
    ctx.lineTo(X(xs[xs.length-1]), top+ih); ctx.lineTo(X(xs[0]), top+ih); ctx.closePath();
    ctx.fillStyle = grad; ctx.fill();
    ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
    for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
    ctx.strokeStyle='rgba(160,200,255,.9)'; ctx.lineWidth=2; ctx.stroke();
  }

  // --- Recent table: always fetch all, then filter client-side
  const dedupe = new Set();
  function keyFor(it){ return it.tx_id || `${it.timestamp}|${it.from_addr}|${it.to_addr}|${it.amount}`; }
  function passesFilter(it){
    const thr = 0.75;
    const risk = Number(it.risk_score ?? it.score ?? 0);
    return !$('#onlyThresh').checked || risk >= thr;
  }
  function formatRow(it){
    const t  = (it.timestamp||'').toString().replace('T',' ').slice(0,19);
    const ft = `${(it.from_addr||'').slice(0,6)}‚Ä¶ ‚Üí ${(it.to_addr||'').slice(0,6)}‚Ä¶`;
    const amt= `${(+it.amount||0).toFixed(2)} ${(it.symbol||'')}`;
    const cat= it.category || 'unknown';
    const risk = Number(it.risk_score ?? it.score ?? 0);
    const cls  = risk >= 0.75 ? 'text-warning' : 'text-success';
    return `<tr><td>${t}</td><td>${ft}</td><td>${amt}</td><td><span class="badge k-badge">${cat}</span></td><td class="${cls}">${risk.toFixed(3)}</td></tr>`;
  }
  function renderRows(items){
    const tbody = $('#tblRecent');
    const rows = [];
    dedupe.clear();
    for(const it of items){
      const k = keyFor(it);
      if(dedupe.has(k)) continue;
      dedupe.add(k);
      if(passesFilter(it)) rows.push(formatRow(it));
    }
    tbody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="5" class="text-muted">No data yet. Try ‚ÄúAnalyze sample‚Äù.</td></tr>`;
  }
  async function loadRecent(){
    const r = await fetch('/uiapi/recent?limit=50&only_alerts=false', {credentials:'include'});
    if(!r.ok) return;
    const data = await r.json();
    const items = (data.items || []).slice(0,50).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    renderRows(items);
  }
  $('#onlyThresh').addEventListener('change', loadRecent);

  // --- WebSocket live insert
  function connectWS(){
    try{
      const wsUrl = (location.protocol==='https:'?'wss':'ws') + '://' + location.host + '/ws/alerts';
      const ws = new WebSocket(wsUrl);
      ws.onopen = ()=> ws.send(JSON.stringify({ping: Date.now()}));
      ws.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data||'{}');
          if(msg.type==='tx' && msg.item){
            const it = msg.item;
            const k = keyFor(it);
            if(!dedupe.has(k) && passesFilter(it)){
              dedupe.add(k);
              const tbody = $('#tblRecent');
              const row = document.createElement('tr');
              row.innerHTML = formatRow(it).replace(/^<tr>|<\/tr>$/g,'');
              if (tbody.firstElementChild && tbody.firstElementChild.children.length===5) {
                tbody.insertBefore(row, tbody.firstElementChild);
              } else {
                tbody.innerHTML = ''; tbody.appendChild(row);
              }
              while(tbody.children.length > 50) tbody.lastElementChild.remove();
            }
          }
        }catch{}
      };
      ws.onclose = ()=> setTimeout(connectWS, 1500);
      ws.onerror = ()=> ws.close();
    }catch{}
  }

  // --- Quick actions
  $('#fetchXRPL')?.addEventListener('click', async ()=>{
    const acct = prompt('XRPL account to fetch (e.g. rEb8TK3gBgk5...)','rEb8TK3gBgk5auZkwc6sHnwrGVJH8DuaLh');
    if (!acct) return;
    const url = `/uiapi/integrations/xrpl/fetch_and_save?account=${encodeURIComponent(acct)}&limit=10`;
    try{
      const r = await fetch(url, withCsrf({ method:'POST' }));
      if(!r.ok){
        const text = await r.text().catch(()=> '');
        toast(`Fetch failed (${r.status}) ${text.slice(0,120)}`, 'err', 5000);
      } else {
        toast('Fetched & saved ‚úì');
        await loadMetricsOnce(); await loadRecent();
      }
    }catch(e){ toast(`Fetch error: ${e?.message||e}`, 'err', 5000); }
  });
  $('#analyzeSample')?.addEventListener('click', async ()=>{
    const r = await fetch('/uiapi/analyze/sample', withCsrf({ method:'POST' }));
    toast(r.ok ? 'Sample analyzed ‚úì' : 'Analyze failed', r.ok ? 'ok' : 'err');
    await loadMetricsOnce(); await loadRecent();
  });
  // Export: point to session route that exists
  $('#exportCsv')?.setAttribute('href', '/uiapi/export/csv/download');
  $('#btnLoadDemo')?.addEventListener('click', async ()=>{
    try{
      const r = await fetch('/uiapi/analyze/sample', withCsrf({ method:'POST' }));
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        toast(`Could not load demo data (${r.status}) ${t.slice(0,120)}`, 'err', 5000);
      } else {
        toast('Demo data loaded ‚úì');
        await loadMetricsOnce(); await loadRecent();
      }
    }catch(e){ toast(`Demo load error: ${e?.message||e}`, 'err', 5000); }
  });

  // Saved wallets (Create tab)
  async function loadWalletPrefs(){
    try{
      const r = await fetch('/me/settings', {credentials:'include'});
      if(!r.ok) return {saved_wallets:[]};
      const s = await r.json();
      return s.ui_prefs || {saved_wallets:[]};
    }catch{ return {saved_wallets:[]}; }
  }
  async function saveWalletPrefs(prefs){
    await fetch('/me/settings', {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ui_prefs: prefs })
    });
  }
  async function refreshWalletList(){
    const prefs = await loadWalletPrefs();
    const list = prefs.saved_wallets || [];
    const el = $('#walletList');
    if(!list.length){ el.innerHTML = 'No wallets yet.'; return; }
    el.innerHTML = list.map(a => `
      <div class="d-flex align-items-center gap-2 my-1">
        <code class="flex-grow-1">${a}</code>
        <button class="btn btn-outline-light btn-sm" data-act="fetch" data-acct="${a}">Fetch live</button>
        <button class="btn btn-outline-light btn-sm" data-act="remove" data-acct="${a}">Remove</button>
      </div>
    `).join('');
    el.querySelectorAll('button').forEach(b=>{
      b.onclick = async (e)=>{
        const acct = e.currentTarget.dataset.acct;
        if(e.currentTarget.dataset.act === 'fetch'){
          const r = await fetch(`/uiapi/integrations/xrpl/fetch_and_save?account=${encodeURIComponent(acct)}&limit=10`, withCsrf({method:'POST'}));
          toast(r.ok ? `Fetched ${acct} ‚úì` : `Fetch failed for ${acct}`, r.ok ? 'ok':'err');
          await loadMetricsOnce(); await loadRecent();
        }else{
          const prefs2 = await loadWalletPrefs();
          prefs2.saved_wallets = (prefs2.saved_wallets||[]).filter(x=>x!==acct);
          await saveWalletPrefs(prefs2);
          refreshWalletList();
        }
      };
    });
    $('#btnAddWallet').onclick = async ()=>{
      const a = ($('#walletInput').value||'').trim();
      if(!a) return;
      const prefs2 = await loadWalletPrefs();
      const set = new Set(prefs2.saved_wallets||[]);
      set.add(a);
      prefs2.saved_wallets = [...set];
      await saveWalletPrefs(prefs2);
      $('#walletInput').value='';
      refreshWalletList();
    };
  }

  async function loadMetricsOnce(){
    try{
      const r = await fetch(`/metrics-ui?days=7`, { credentials:'include' });
      if(!r.ok) throw 0;
      const data = await r.json();
      paintKPIs(data);
      paintChart(data.series_by_day || []);
    }catch{}
  }

  function setSelected(tab){
    const target = tab.getAttribute('aria-controls');
    tabs.forEach(t=>{ const sel = (t===tab); t.setAttribute('aria-selected', sel); t.tabIndex = sel ? 0 : -1; });
    panels.forEach(p => p.hidden = (p.id !== target));
    tab.focus({preventScroll:true});
    const hash = '#' + (tab.id.replace(/^tab-/, ''));
    if (location.hash !== hash) history.replaceState(null, '', hash);
    document.title = 'Klerno ‚Ä¢ ' + tab.textContent;
    body.dataset.active = hash.slice(1);
    if (hash === '#admin' && body.dataset.role !== 'admin') {
      toast('Admins only', 'warn');
      history.replaceState(null, '', '#home');
      selectTabById('tab-home');
    }
  }
  function selectTabById(id){ const tab = $('#'+id); if (tab) setSelected(tab); }
  $('#tabs').addEventListener('click', (e)=>{ const btn = e.target.closest('[role="tab"]'); if(btn) setSelected(btn); });
  function routeFromHash(){
    const valid = new Set(['home','explore','create','alerts','profile','admin']);
    const raw = (location.hash || '#home').replace('#','').toLowerCase().trim();
    const name = valid.has(raw) ? raw : 'home';
    if (name==='admin' && body.dataset.role !== 'admin'){ toast('Admins only', 'warn'); history.replaceState(null, '', '#home'); selectTabById('tab-home'); return; }
    selectTabById('tab-' + name);
  }
  window.addEventListener('hashchange', routeFromHash);

  (async function boot(){
    await loadMe();
    await loadMetricsOnce();
    await loadRecent();
    await refreshWalletList();
    connectWS();
    setInterval(()=>{ if(!document.hidden){ loadMetricsOnce(); loadRecent(); } }, 5000);
    routeFromHash();
  })();

  // background animation (unchanged except tiny fix)
  (function(){
    const bg = document.getElementById('bg'); if(!bg) return;
    const ctx = bg.getContext('2d');
    let W,H,DPR=Math.min(window.devicePixelRatio||1,2), P=[];
    function rnd(){ return Math.random(); }
    function resize(){
      W=bg.width = Math.floor(innerWidth*DPR);
      H=bg.height= Math.floor(innerHeight*DPR);
      bg.style.width = innerWidth+'px'; bg.style.height= innerHeight+'px';
      const n=Math.floor((W*H)/(90_000*DPR));
      P = Array.from({length:n},()=>({ x:rnd()*W, y:rnd()*H, vx:(rnd()-.5)*.35*DPR, vy:(rnd()-.5)*.35*DPR }));
    }
    function step(){
      ctx.clearRect(0,0,W,H);
      const g=ctx.createLinearGradient(0,0,W,H);
      g.addColorStop(0,'rgba(123,108,255,.10)'); g.addColorStop(.5,'rgba(0,225,255,.08)'); g.addColorStop(1,'rgba(255,255,255,.05)');
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='rgba(255,255,255,.45)';
      for(const p of P){
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>W) p.vx*=-1;
        if(p.y<0||p.y>H) p.vy*=-1; /* fixed */
        ctx.beginPath(); ctx.arc(p.x,p.y,1.3*DPR,0,Math.PI*2); ctx.fill();
      }
      ctx.strokeStyle='rgba(200,220,255,.11)';
      for(let i=0;i<P.length;i++){
        const a=P[i];
        for(let j=i+1;j<P.length;j++){
          const b=P[j],dx=a.x-b.x,dy=a.y-b.y,d2=dx*dx+dy*dy;
          if(d2<18000*DPR){
            ctx.globalAlpha=1-d2/(18000*DPR);
            ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          }
        }
      }
      ctx.globalAlpha=1; requestAnimationFrame(step);
    }
    resize(); requestAnimationFrame(step); addEventListener('resize', resize);
  })();
})();
</script>
{% endblock %}
